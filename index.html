<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Empire Ecosystem Map — UAE Property Hub</title>

<!-- Open Graph / Social Sharing -->
<meta property="og:title" content="Empire Ecosystem Map — UAE Property Hub">
<meta property="og:description" content="Interactive architecture map of 22 interconnected systems: AI engines, WhatsApp bots, marketing agents, property databases, and more. Built by Dr. Siyamak Sasani.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://siyamaksasani.github.io/empire-ecosystem-map/">
<meta property="og:image" content="https://siyamaksasani.github.io/empire-ecosystem-map/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Empire Ecosystem Map — UAE Property Hub">
<meta name="twitter:description" content="Interactive architecture map of 22 interconnected systems: AI engines, WhatsApp bots, marketing agents, property databases, and more.">
<meta name="twitter:image" content="https://siyamaksasani.github.io/empire-ecosystem-map/og-image.png">

<meta name="description" content="Interactive architecture map of 22 interconnected systems powering UAE Property Hub — AI engines, WhatsApp bots, marketing agents, property databases, and more.">
<meta name="author" content="Dr. Siyamak Sasani">
<meta name="theme-color" content="#080c14">

<!-- Inline SVG Favicon -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23080c14'/><text x='50' y='68' font-size='60' text-anchor='middle' fill='%2322d3ee'>⚡</text></svg>">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080c14;--bg2:#0f1520;--bg3:#161e2e;--border:#253048;
  --text:#e8ecf4;--text2:#8896ab;--text3:#5c6b82;
  --green:#2dd4a8;--blue:#4a9eff;--orange:#f5a623;--purple:#b07af5;
  --red:#f55a5a;--gray:#6b7a90;--gold:#d4a82d;--cyan:#22d3ee;
  --green-z:rgba(45,212,168,0.06);--blue-z:rgba(74,158,255,0.06);
  --orange-z:rgba(245,166,35,0.06);--purple-z:rgba(176,122,245,0.06);
  --red-z:rgba(245,90,90,0.06);--gold-z:rgba(212,168,45,0.06);
  --gray-z:rgba(107,122,144,0.04);
}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh}

/* ── TOPBAR ── */
.topbar{position:fixed;top:0;left:0;right:0;z-index:200;height:48px;background:rgba(15,21,32,0.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:16px}
.topbar h1{font-size:15px;font-weight:800;background:linear-gradient(90deg,var(--green),var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap}
.stats{display:flex;gap:12px;font-size:11px;color:var(--text2);margin-left:8px}
.stats b{color:var(--text);font-weight:700}
.stats .sep{color:var(--border)}
.spacer{flex:1}
.search{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:5px 10px;color:var(--text);font-size:11px;width:160px;outline:none;font-family:inherit}
.search:focus{border-color:var(--blue)}
.tabs{display:flex;gap:1px;background:var(--bg);border-radius:6px;border:1px solid var(--border);padding:2px}
.tab{background:none;border:none;color:var(--text3);padding:4px 10px;font-size:11px;border-radius:4px;cursor:pointer;font-family:inherit;font-weight:500}
.tab.on{background:var(--blue);color:#fff}
.tab:hover:not(.on){color:var(--text)}
.tbtn{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:4px 10px;border-radius:6px;font-size:11px;cursor:pointer;font-family:inherit}
.tbtn:hover{background:var(--border);color:var(--text)}

/* ── CANVAS ── */
.viewport{position:fixed;top:48px;left:0;right:0;bottom:0;overflow:hidden;cursor:grab}
.viewport.dragging{cursor:grabbing}
.world{position:absolute;transform-origin:0 0;will-change:transform}

/* ── SVG LAYER ── */
svg.wires{position:absolute;top:0;left:0;overflow:visible;pointer-events:none;z-index:3}
svg.wires path{fill:none;stroke-linecap:round}
svg.wires .wire{stroke-width:3.5;opacity:0.38}
svg.wires .wire:hover{opacity:0.8;stroke-width:5}
svg.wires .wire.hl{opacity:0.9;stroke-width:5.5}
svg.wires .wire.dim{opacity:0.05}
svg.wires .arrow{stroke:none}
svg.wires text{font-size:11px;font-family:inherit;font-weight:600;pointer-events:none}
svg.wires .wire-label{transition:opacity 0.2s}

@keyframes flowdot{0%{offset-distance:0%}100%{offset-distance:100%}}

/* ── ZONES ── */
.zone{position:absolute;border-radius:20px;z-index:1;pointer-events:none}
.zone-label{position:absolute;font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:2px;opacity:0.35;z-index:2;pointer-events:none}

/* ── COLUMN LABELS ── */
.col-label{position:absolute;z-index:2;pointer-events:none;text-align:center}
.col-label .col-title{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:3px;color:var(--text3);opacity:0.5}
.col-label .col-arrow{font-size:18px;color:var(--text3);opacity:0.25;margin-top:2px}

/* ── NODES ── */
.card{position:absolute;z-index:10;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s,opacity 0.25s;border-radius:14px;overflow:hidden}
.card:hover{transform:translateY(-3px) scale(1.02);z-index:50}
.card.hl{z-index:60;transform:translateY(-4px) scale(1.03)}
.card.dim{opacity:0.12!important;pointer-events:none}
.card-inner{background:var(--bg2);border:1.5px solid var(--border);border-radius:14px;height:100%;display:flex;flex-direction:column}
.card.c-green .card-inner{border-color:rgba(45,212,168,0.35)}
.card.c-green:hover .card-inner,.card.c-green.hl .card-inner{border-color:var(--green);box-shadow:0 0 30px rgba(45,212,168,0.15)}
.card.c-blue .card-inner{border-color:rgba(74,158,255,0.35)}
.card.c-blue:hover .card-inner,.card.c-blue.hl .card-inner{border-color:var(--blue);box-shadow:0 0 30px rgba(74,158,255,0.15)}
.card.c-orange .card-inner{border-color:rgba(245,166,35,0.35)}
.card.c-orange:hover .card-inner,.card.c-orange.hl .card-inner{border-color:var(--orange);box-shadow:0 0 30px rgba(245,166,35,0.15)}
.card.c-purple .card-inner{border-color:rgba(176,122,245,0.35)}
.card.c-purple:hover .card-inner,.card.c-purple.hl .card-inner{border-color:var(--purple);box-shadow:0 0 30px rgba(176,122,245,0.15)}
.card.c-red .card-inner{border-color:rgba(245,90,90,0.35)}
.card.c-red:hover .card-inner,.card.c-red.hl .card-inner{border-color:var(--red);box-shadow:0 0 30px rgba(245,90,90,0.15)}
.card.c-gold .card-inner{border-color:rgba(212,168,45,0.35)}
.card.c-gold:hover .card-inner,.card.c-gold.hl .card-inner{border-color:var(--gold);box-shadow:0 0 30px rgba(212,168,45,0.15)}
.card.c-gray .card-inner{border-color:rgba(107,122,144,0.25);opacity:0.55}
.card.c-hub .card-inner{border:2.5px solid var(--cyan);box-shadow:0 0 40px rgba(34,211,238,0.12)}
.card.c-hub:hover .card-inner,.card.c-hub.hl .card-inner{box-shadow:0 0 60px rgba(34,211,238,0.22)}

.card-top{padding:14px 16px 10px;display:flex;align-items:center;gap:12px}
.card-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;background:rgba(255,255,255,0.06)}
.card-name{font-size:18px;font-weight:800;line-height:1.15}
.card-sub{font-size:12px;color:var(--text2);margin-top:3px;line-height:1.3}
.card-status{width:10px;height:10px;border-radius:50%;margin-left:auto;flex-shrink:0}
.card-status.live{background:var(--green);box-shadow:0 0 8px rgba(45,212,168,0.5);animation:pulse 2s infinite}
.card-status.dev{background:var(--orange);box-shadow:0 0 8px rgba(245,166,35,0.4)}
.card-status.parked{background:var(--gray)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.35}}

.card-stat{padding:0 16px 12px;font-size:11px;color:var(--text2);display:flex;gap:10px;flex-wrap:wrap}
.card-stat .pill{background:rgba(255,255,255,0.05);padding:2px 8px;border-radius:4px;font-weight:500}

/* ── TOOLTIP ── */
.tip{position:fixed;z-index:500;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:14px 18px;max-width:360px;font-size:12px;line-height:1.6;color:var(--text2);pointer-events:none;opacity:0;transition:opacity 0.15s;box-shadow:0 12px 40px rgba(0,0,0,0.5)}
.tip.show{opacity:1}
.tip strong{color:var(--text);font-weight:700;display:block;margin-bottom:4px;font-size:13px}
.tip .tip-tags{margin-top:6px;display:flex;flex-wrap:wrap;gap:4px}
.tip .tt{background:rgba(74,158,255,0.12);color:var(--blue);padding:1px 6px;border-radius:3px;font-size:10px;font-weight:600}

/* ── WIRE TOOLTIP ── */
.wire-tip{position:fixed;z-index:500;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:11px;font-weight:600;color:var(--text);pointer-events:none;opacity:0;transition:opacity 0.15s;white-space:nowrap}
.wire-tip.show{opacity:1}

/* ── DETAIL PANEL ── */
.dpanel{position:fixed;top:48px;right:-440px;width:420px;bottom:0;z-index:150;background:var(--bg2);border-left:1px solid var(--border);transition:right 0.3s;overflow-y:auto}
.dpanel.open{right:0}
.dp-head{padding:20px 24px 14px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg2);z-index:2}
.dp-close{position:absolute;top:14px;right:14px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center}
.dp-close:hover{color:var(--text);background:var(--border)}
.dp-title{font-size:20px;font-weight:800}
.dp-sub{font-size:12px;color:var(--text2);margin-top:4px}
.dp-body{padding:20px 24px 40px}
.dp-sec{margin-bottom:22px}
.dp-sec h4{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);font-weight:700;margin-bottom:8px}
.dp-sec p{font-size:12px;line-height:1.65;color:var(--text2)}
.dp-row{display:flex;justify-content:space-between;padding:5px 0;font-size:12px;border-bottom:1px solid rgba(255,255,255,0.03)}
.dp-row .dk{color:var(--text2)}.dp-row .dv{color:var(--text);font-weight:600;font-family:monospace;font-size:11px}
.dp-tag{display:inline-block;background:rgba(74,158,255,0.12);color:var(--blue);padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;margin:2px}
.dp-agent{padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:12px}
.dp-agent b{color:var(--text)}
.dp-conn{padding:4px 0;font-size:11px;color:var(--text2)}
.dp-conn::before{content:'\2192';color:var(--cyan);margin-right:6px}

/* ── FLOW PANEL ── */
.flows{position:fixed;bottom:16px;right:16px;z-index:200;background:rgba(15,21,32,0.92);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:14px;padding:14px 18px;max-width:420px;font-size:11px}
.flows.shut .flows-body{display:none}
.flows.shut{padding:10px 14px}
.flows-head{cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:12px;user-select:none}
.flows.shut .flows-head{margin-bottom:0}
.flows-body{margin-top:8px}
.fi{padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:color 0.15s;display:flex;align-items:flex-start;gap:8px}
.fi:last-child{border:none}
.fi:hover{color:var(--cyan)}
.fi-n{min-width:20px;height:20px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;color:var(--cyan);flex-shrink:0}

/* ── LEGEND ── */
.legend{position:fixed;bottom:16px;left:16px;z-index:200;background:rgba(15,21,32,0.92);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:14px;padding:14px 18px;font-size:11px;max-width:280px}
.legend.shut .legend-body{display:none}
.legend.shut{padding:10px 14px}
.legend-head{cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:12px;user-select:none}
.legend.shut .legend-head{margin-bottom:0}
.legend-body{margin-top:8px}
.lr{display:flex;align-items:center;gap:8px;padding:2px 0}
.ld{width:10px;height:10px;border-radius:3px;flex-shrink:0}

.zoom-ind{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);z-index:200;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 12px;font-size:11px;color:var(--text2);opacity:0;transition:opacity 0.3s;pointer-events:none}
.zoom-ind.show{opacity:1}
</style>
</head>
<body>

<div class="topbar">
  <h1>Empire Ecosystem</h1>
  <div class="stats">
    <span><b>15</b> Active Systems</span><span class="sep">|</span>
    <span><b>3</b> CF Workers</span><span class="sep">|</span>
    <span><b>4</b> AI Engines</span><span class="sep">|</span>
    <span><b>10</b> MCC Agents</span><span class="sep">|</span>
    <span><b>15,957+</b> Properties</span><span class="sep">|</span>
    <span><b>5</b> Databases</span>
  </div>
  <div class="spacer"></div>
  <input class="search" type="text" placeholder="Search systems..." id="search">
  <div class="tabs" id="tabs">
    <button class="tab on" data-v="all">All</button>
    <button class="tab" data-v="infra">Infra</button>
    <button class="tab" data-v="ai">AI</button>
    <button class="tab" data-v="leads">Leads</button>
  </div>
  <button class="tbtn" id="fitBtn">Fit</button>
  <button class="tbtn" id="fsBtn">Fullscreen</button>
  <button class="tbtn" id="pdfBtn">PDF</button>
</div>

<div class="viewport" id="vp">
  <div class="world" id="world"></div>
</div>

<div class="tip" id="tip"></div>
<div class="wire-tip" id="wtip"></div>
<div class="zoom-ind" id="zi">100%</div>

<div class="dpanel" id="dp">
  <div class="dp-head">
    <button class="dp-close" id="dpClose">&times;</button>
    <div class="dp-title" id="dpTitle"></div>
    <div class="dp-sub" id="dpSub"></div>
  </div>
  <div class="dp-body" id="dpBody"></div>
</div>

<div class="flows" id="flows">
  <div class="flows-head" id="flowsHead">Data Flows (hover to trace) <span id="fArr">&#9660;</span></div>
  <div class="flows-body">
    <div class="fi" data-f="1"><span class="fi-n">1</span><span>WhatsApp Lead &#8594; Atlas2 &#8594; CRM &#8594; Empire CC &#8594; Property Hub</span></div>
    <div class="fi" data-f="2"><span class="fi-n">2</span><span>Visitor &#8594; Empire Tracker &#8594; Empire CC &#8594; Telegram Alert</span></div>
    <div class="fi" data-f="3"><span class="fi-n">3</span><span>Launch Interceptor &#8594; Detect Launch &#8594; Empire CC &#8594; All Agents</span></div>
    <div class="fi" data-f="4"><span class="fi-n">4</span><span>MCC Agents &#8594; Platforms &#8594; Leads &#8594; Empire CC</span></div>
    <div class="fi" data-f="5"><span class="fi-n">5</span><span>Ottawa-Dubai &#8594; CAD/AED Monitor &#8594; Content &#8594; MCC</span></div>
    <div class="fi" data-f="6"><span class="fi-n">6</span><span>WhatsApp Groups &#8594; Atlas2 Ingestion &#8594; Property Hub DB &#8594; Admin Review</span></div>
  </div>
</div>

<div class="legend" id="legend">
  <div class="legend-head" id="legHead">Legend <span id="lArr">&#9660;</span></div>
  <div class="legend-body">
    <div class="lr"><div class="ld" style="background:var(--green)"></div>Production / Active</div>
    <div class="lr"><div class="ld" style="background:var(--blue)"></div>Cloudflare Workers</div>
    <div class="lr"><div class="ld" style="background:var(--orange)"></div>AI / Intelligence</div>
    <div class="lr"><div class="ld" style="background:var(--purple)"></div>Content / Marketing</div>
    <div class="lr"><div class="ld" style="background:var(--red)"></div>Revenue / Lead Systems</div>
    <div class="lr"><div class="ld" style="background:var(--gold)"></div>Side Businesses</div>
    <div class="lr"><div class="ld" style="background:var(--gray)"></div>Parked / Archive</div>
    <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
      <div class="lr" style="color:var(--text2)"><div class="ld" style="background:var(--green);border-radius:50%;width:8px;height:8px"></div>Live</div>
      <div class="lr" style="color:var(--text2)"><div class="ld" style="background:var(--orange);border-radius:50%;width:8px;height:8px"></div>In Dev</div>
      <div class="lr" style="color:var(--text2)"><div class="ld" style="background:var(--gray);border-radius:50%;width:8px;height:8px"></div>Parked</div>
    </div>
    <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);color:var(--text3)">
      Lines: <span style="color:var(--red)">&#9644;</span> leads &nbsp;<span style="color:var(--blue)">&#9644;</span> data &nbsp;<span style="color:var(--purple)">&#9644;</span> content &nbsp;<span style="color:var(--gold)">&#9644;</span> alerts
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════
// HORIZONTAL LAYOUT: L→R story flow
// Col 0 (x~60):   LEAD SOURCES
// Col 1 (x~420):  AI PROCESSING
// Col 2 (x~820):  COMMAND CENTER (hub)
// Col 3 (x~1220): DATA/STORAGE
// Col 4 (x~1620): OUTPUTS
// Col 5 (x~2020): SIDE / SUPPORT
// ═══════════════════════════════════════════

const W=280, H=110; // card size
const N=[
  // ── COL 0: LEAD SOURCES ──
  {id:'atlas2',title:'Atlas2 WhatsApp Bot',sub:'24/7 Lead Qualifier',icon:'\uD83D\uDCAC',c:'red',s:'live',x:60,y:80,cat:['all','ai','leads'],
   stat:'Groq + Claude AI \u2022 166 tests',
   tags:['Node.js','Baileys','SQLite','Groq+Claude','Port 18790'],
   detail:{desc:'Primary WhatsApp bot using Baileys (WhatsApp Web protocol) with dual AI: Groq for speed, Claude for complex reasoning. Handles voice (Whisper), images, NLP property search (40+ area aliases), CRM integration, proactive outreach (48hr follow-ups, broadcast, reminders). Detects Arabic/Farsi/English. 166 tests across 4 suites.',
     infra:[{k:'Host',v:'Local Mac'},{k:'Port',v:'18790'},{k:'DB',v:'SQLite WAL ~/.atlas2-whatsapp/'},{k:'AI',v:'Groq llama-3.3-70b + Claude'},{k:'Voice',v:'Groq Whisper'},{k:'Tests',v:'166 across 4 suites'},{k:'Path',v:'~/projects/atlas2-whatsapp/'}],
     mods:['ai-engine.js','property-search.js','outreach.js','conversation.js','voice.js','crm.js','language.js','intelligence.js','gateway.js','media.js','group-context-buffer.js','topic-filter.js','sender-map.js'],
     conns:['Groq API (LLM + Whisper)','Anthropic API (Claude)','CRM API (Bearer)','Ingestion API','Empire CC']}},
  {id:'wa-auto',title:'WhatsApp Automation',sub:'Cloud API Webhook Relay',icon:'\u2601\uFE0F',c:'blue',s:'live',x:60,y:240,cat:['all','infra','leads'],
   stat:'CF Worker \u2022 D1: whatsapp-auto',
   tags:['CF Worker','D1','WhatsApp Cloud API'],
   detail:{desc:'Cloudflare Worker receiving WhatsApp Cloud API webhooks. Stores messages in D1, relays to Empire CC via service binding (zero-latency). Routes property queries to Property Hub API.',
     infra:[{k:'Runtime',v:'CF Worker'},{k:'DB',v:'D1: whatsapp-auto'},{k:'Service Binding',v:'EMPIRE \u2192 empire-cc'},{k:'Path',v:'~/projects/whatsapp-automation/'}],
     mods:['Webhook Handler','Message Router','D1 Storage','Empire Service Binding'],
     conns:['WhatsApp Cloud API','Empire CC (service binding)','Property Hub API']}},
  {id:'tracker',title:'Empire Tracker',sub:'Visitor Behavioral Scoring',icon:'\uD83D\uDC41\uFE0F',c:'blue',s:'live',x:60,y:400,cat:['all','infra','leads'],
   stat:'CF Worker \u2022 D1: tracker-db',
   tags:['CF Worker','D1','Tracking Pixel','JS Embed'],
   detail:{desc:'Lightweight CF Worker serving a tracking pixel on realedata.ai. Captures page views, scroll depth, time-on-page, clicks. Scores visitors by intent, alerts Telegram for high-intent signals.',
     infra:[{k:'Runtime',v:'CF Worker'},{k:'DB',v:'D1: empire-tracker-db'},{k:'Pixel',v:'tracking.js / tracking.min.js'},{k:'Path',v:'~/projects/empire-tracker/'}],
     mods:['Tracking Pixel (JS)','Visitor Score Calculator','Behavioral Logger','High-Intent Alert Engine'],
     conns:['Empire CC','realedata.ai (pixel embedded)','Telegram alerts']}},
  {id:'atlas3',title:'Atlas3 Lead Agent',sub:'PARKED \u2014 Future 2nd Number',icon:'\uD83D\uDCAC',c:'gray',s:'parked',x:60,y:560,cat:['all'],
   stat:'Parked \u2022 launchd plist ready',
   tags:['Node.js','Baileys','Parked'],
   detail:{desc:'Secondary WhatsApp bot for a second phone number. Forked from Atlas2. launchd plist configured for auto-start. Will be activated for campaign segmentation or overflow.',
     infra:[{k:'Status',v:'PARKED'},{k:'Auto-start',v:'launchd plist ready'},{k:'Path',v:'~/projects/atlas3-lead-agent/'}],
     mods:['Same as Atlas2 (forked)'],conns:['Would connect to Empire CC']}},

  // ── COL 1: AI PROCESSING ──
  {id:'groq',title:'Groq API',sub:'llama-3.3-70b + Whisper',icon:'\u26A1',c:'orange',s:'live',x:460,y:80,cat:['all','ai'],
   stat:'Free tier \u2022 <1s latency',
   tags:['LLM','Whisper','Free tier'],
   detail:{desc:'Ultra-fast AI inference. Primary AI for Atlas2 WhatsApp (real-time conversations + voice transcription via Whisper). Also used by Launch Interceptor and Ottawa-Dubai.',
     infra:[{k:'LLM',v:'llama-3.3-70b-versatile'},{k:'Voice',v:'Whisper transcription'},{k:'Cost',v:'Free tier'},{k:'Latency',v:'<1 second'}],
     mods:['Chat completions','Audio transcription'],conns:['Atlas2 WhatsApp','Launch Interceptor','Ottawa-Dubai']}},
  {id:'clawd',title:'Clawd',sub:'AI Agent Framework \u2014 4 Agents',icon:'\uD83E\uDD16',c:'orange',s:'dev',x:460,y:240,cat:['all','ai'],
   stat:'Hub \u2022 Optical \u2022 ReLead \u2022 Roadshow',
   tags:['4 Domain Agents','Memory','Identity','Canvas'],
   detail:{desc:'Multi-agent AI framework. 4 specialized agents each with persistent identity, memory, heartbeat, bootstrap config. Hub Agent (property ops), Optical Agent (Dubai Optical B2B), ReLead Agent (lead gen), Roadshow Agent (March 2026 seminars).',
     infra:[{k:'Agents',v:'4 domain specialists'},{k:'Canvas',v:'HTML interface'},{k:'Path',v:'~/projects/clawd/'}],
     mods:['Agent Runtime','Memory Store','Identity System','Heartbeat Monitor','Canvas UI'],
     agents:[{n:'Hub Agent',d:'Property Hub operations'},{n:'Optical Agent',d:'Dubai Optical B2B wellness'},{n:'ReLead Agent',d:'Lead gen & qualification'},{n:'Roadshow Agent',d:'March 2026 seminars'}],
     conns:['UAE Property Hub','Dubai Optical','MCC','Empire CC']}},
  {id:'launch',title:'Launch Interceptor',sub:'Predictive Market Intelligence',icon:'\uD83D\uDE80',c:'orange',s:'dev',x:460,y:400,cat:['all','ai'],
   stat:'Python + Groq \u2022 Auto-scan',
   tags:['Python','Groq AI','Scrapers','Alerts'],
   detail:{desc:'Scrapes developer websites and market sources to detect new Dubai property launches before public announcement. Groq AI for content analysis. Configurable scan intervals and confidence thresholds.',
     infra:[{k:'Stack',v:'Python + Groq'},{k:'Scan',v:'Configurable interval'},{k:'Path',v:'~/projects/launch-interceptor/'}],
     mods:['Scrapers','Analyzers','Alert Engine','API Server','Database'],
     conns:['Empire CC','Telegram','Groq API','MCC']}},
  {id:'ottawa',title:'Ottawa-Dubai Arbitrage',sub:'Cross-Border Content Engine',icon:'\uD83C\uDF0D',c:'orange',s:'dev',x:460,y:560,cat:['all','ai'],
   stat:'CAD/AED monitor \u2022 Content gen',
   tags:['Python','Currency','Content Gen','Leads'],
   detail:{desc:'Monitors CAD/AED exchange rates for favorable investment windows. Generates targeted cross-border content for Canadian investors. Feeds content to MCC for multi-platform distribution.',
     infra:[{k:'Stack',v:'Python'},{k:'Rates',v:'CAD/AED configurable thresholds'},{k:'Path',v:'~/projects/ottawa-dubai-arbitrage/'}],
     mods:['Currency Monitor','Content Generators','Market Monitors','Lead Trackers','Empire Integration'],
     conns:['Empire CC','Exchange Rate API','Groq API','MCC']}},

  // ── COL 2: COMMAND CENTER (HUB) ──
  {id:'empire',title:'Empire Command Center',sub:'Central Event Bus & Registry',icon:'\u26A1',c:'hub',s:'live',x:900,y:280,cat:['all','infra'],
   stat:'CF Worker \u2022 D1 \u2022 Cron 5min \u2022 Dashboard',
   tags:['CF Worker','D1: empire-cc','Cron: 5min','React Dashboard'],
   detail:{desc:'Central nervous system. Routes events between ALL services. Health checks every 5 min (cron). React/Vite dashboard for real-time monitoring. Service binding target for WhatsApp Automation.',
     infra:[{k:'Runtime',v:'CF Worker'},{k:'DB',v:'D1: empire-cc'},{k:'Cron',v:'*/5 * * * *'},{k:'Dashboard',v:'React/Vite app'},{k:'Path',v:'~/projects/empire-command-center/'}],
     mods:['Event Router','Health Monitor','Dashboard API','Service Registry','Dashboard App'],
     conns:['All 8+ services report here','Broadcasts to subscribers','Service binding from WA Automation']}},

  // ── COL 3: DATA/STORAGE ──
  {id:'hub',title:'UAE Property Hub',sub:'realedata.ai \u2014 Core Platform',icon:'\uD83C\uDFE2',c:'green',s:'live',x:1340,y:80,cat:['all','infra','leads'],
   stat:'15,957+ properties \u2022 65+ developers',
   tags:['FastAPI','React','PostgreSQL','AWS Lightsail'],
   detail:{desc:'Flagship SaaS platform. 15,957+ properties (12,836 + 3,121 ingested) across 65+ developers. Atlas AI 125-point scoring, admin dashboard, broker tools, Stripe billing, Google Maps.',
     infra:[{k:'Host',v:'AWS Lightsail 65.0.250.47'},{k:'DB',v:'PostgreSQL (AWS Stockholm)'},{k:'Backend',v:'FastAPI (Python)'},{k:'Frontend',v:'React + Vite + Tailwind'},{k:'Properties',v:'15,957+'},{k:'Developers',v:'65+'},{k:'Path',v:'~/projects/uae-property-hub/'}],
     mods:['Atlas AI (125-pt scoring)','Atlas Assistant','Atlas Matcher','Bulk Upload','Business Router','Scoring Engine','Context Engine','Data Cleaner','DeepSeek Research','AI Orchestrator','Universal Parser'],
     conns:['OpenAI API','Google Maps','Stripe','Telegram','Empire CC']}},
  {id:'pg',title:'PostgreSQL',sub:'AWS Stockholm \u2014 Primary DB',icon:'\uD83D\uDDC4\uFE0F',c:'green',s:'live',x:1340,y:280,cat:['all','infra'],
   stat:'15,957+ properties \u2022 65+ devs',
   tags:['AWS Stockholm','Alembic migrations'],
   detail:{desc:'Primary database. Stores all property listings, developer profiles, user accounts, Atlas scores, analytics.',
     infra:[{k:'Region',v:'AWS Stockholm'},{k:'Properties',v:'15,957+'},{k:'Developers',v:'65+'},{k:'Migrations',v:'Alembic'}],
     mods:['Property Listings','Developer Profiles','User Accounts','Atlas Scores'],conns:['UAE Property Hub backend']}},
  {id:'lightsail',title:'AWS Lightsail',sub:'65.0.250.47 \u2014 Server',icon:'\u2601\uFE0F',c:'green',s:'live',x:1340,y:450,cat:['all','infra'],
   stat:'Ubuntu \u2022 Docker \u2022 ap-south-1',
   tags:['Ubuntu','Docker','SSH'],
   detail:{desc:'Primary cloud server. Docker containers running FastAPI backend.',
     infra:[{k:'IP',v:'65.0.250.47'},{k:'Region',v:'ap-south-1 (Mumbai)'},{k:'OS',v:'Ubuntu'},{k:'Deploy',v:'Docker + git pull'}],
     mods:['FastAPI Container','Docker Engine'],conns:['PostgreSQL (Stockholm)','Internet (realedata.ai)']}},
  {id:'telegram',title:'Telegram Alerts',sub:'Real-time Notifications',icon:'\uD83D\uDCF1',c:'green',s:'live',x:1340,y:610,cat:['all','infra'],
   stat:'Chat 365560664 \u2022 4+ sources',
   tags:['Bot API','Multi-source alerts'],
   detail:{desc:'Aggregates real-time alerts: Property Hub events, Empire Tracker high-intent visitors, Launch Interceptor new launches, system health.',
     infra:[{k:'Chat ID',v:'365560664'},{k:'Sources',v:'4+ systems'}],
     mods:['Property alerts','Visitor alerts','Launch alerts','Health alerts'],conns:['Property Hub','Empire Tracker','Launch Interceptor','Empire CC']}},

  // ── COL 4: OUTPUTS ──
  {id:'mcc',title:'Marketing Command Center',sub:'10 AI Agents \u2014 Omnichannel',icon:'\uD83D\uDCE2',c:'purple',s:'dev',x:1780,y:80,cat:['all','leads'],
   stat:'LinkedIn \u2022 Insta \u2022 FB \u2022 X \u2022 TT \u2022 YT + 3',
   tags:['PostgreSQL','10 Agents','Orchestrator','Analytics'],
   detail:{desc:'10 AI agents managing all social platforms. Orchestrator coordinates campaigns. Market data scrapers, analytics engine, content queue.',
     infra:[{k:'DB',v:'PostgreSQL: marketing_command_center'},{k:'Agents',v:'10 platform specialists'},{k:'Path',v:'~/projects/marketing-command-center/'}],
     mods:['Master Orchestrator','Market Data Scrapers','Analytics Engine','Content Queue'],
     agents:[{n:'LinkedIn',d:'B2B thought leadership'},{n:'Instagram',d:'Visual property content'},{n:'Facebook',d:'Community & ads'},{n:'Twitter/X',d:'Market commentary'},{n:'TikTok',d:'Short-form video'},{n:'YouTube',d:'Long-form content'},{n:'Analytics',d:'Performance tracking'},{n:'Content Factory',d:'Content generation'},{n:'Lead Capture',d:'Cross-platform leads'}],
     conns:['Empire CC','All social platforms','Ottawa-Dubai content','Launch Interceptor intel']}},
  {id:'videos',title:'Dubai Social Videos',sub:'Programmatic Video Gen',icon:'\uD83C\uDFAC',c:'purple',s:'dev',x:1780,y:210,cat:['all'],
   stat:'Remotion + React',
   tags:['Remotion','Node.js','React'],
   detail:{desc:'Generates social media videos programmatically using Remotion. Property showcases, market updates, area spotlights.',
     infra:[{k:'Stack',v:'Remotion + React + TypeScript'},{k:'Path',v:'~/projects/dubai-social-videos/'}],
     mods:['Video Templates','Render Pipeline','Multi-format output'],conns:['MCC Content Factory','Property Hub data']}},
  {id:'myvid',title:'My Video Project',sub:'Node.js Video Pipeline',icon:'\uD83C\uDFA5',c:'purple',s:'dev',x:1780,y:340,cat:['all'],
   stat:'Node.js',tags:['Node.js','Video'],
   detail:{desc:'General video production project.',infra:[{k:'Stack',v:'Node.js'},{k:'Path',v:'~/projects/my-video-project/'}],mods:['Video Pipeline'],conns:['MCC']}},
  {id:'skills',title:'Claude Code Skills',sub:'Custom Dev Toolkit',icon:'\uD83D\uDD27',c:'green',s:'live',x:1780,y:470,cat:['all'],
   stat:'10+ slash commands',
   tags:['TypeScript','10+ skills'],
   detail:{desc:'Custom Claude Code skills: developer-validation (61 devs), MCC management, deployment, broadcasting, analytics, content gen.',
     infra:[{k:'Stack',v:'Node.js + TypeScript'},{k:'Path',v:'~/projects/skills/'}],
     mods:['/developer-validation','/mcc','/deploy','/broadcast','/wake-agents','/agent-status','/marketing-analytics','/generate-content','/standup'],conns:['All projects']}},
  {id:'review',title:'Atlas Review',sub:'Admin Audit Dashboard',icon:'\uD83D\uDD0D',c:'green',s:'live',x:1780,y:600,cat:['all'],
   stat:'React + Vite',tags:['React','Vite','Audit'],
   detail:{desc:'Audit dashboard for Property Hub admin. Findings in ATLAS_FINDINGS.md.',infra:[{k:'Stack',v:'React + Vite'},{k:'Path',v:'~/projects/realedata-atlas-review/'}],mods:['Audit Views','Findings Report'],conns:['Property Hub admin']}},
  {id:'observe',title:'Observability',sub:'Dev Session Monitoring',icon:'\uD83D\uDCCA',c:'green',s:'live',x:1780,y:730,cat:['all'],
   stat:'Metrics & tracking',tags:['Monitoring'],
   detail:{desc:'Monitoring for Claude Code dev sessions.',infra:[{k:'Path',v:'~/projects/claude-code-observability/'}],mods:['Session Tracking','Metrics'],conns:['Dev workflow']}},

  // ── COL 5: SIDE BUSINESS + ARCHIVE ──
  {id:'supp-api',title:'Supplement E-commerce',sub:'FastAPI + PG + Redis Store',icon:'\uD83D\uDC8A',c:'gold',s:'dev',x:2220,y:80,cat:['all'],
   stat:'Docker \u2022 R2 images',
   tags:['FastAPI','PostgreSQL','Redis','Docker','R2'],
   detail:{desc:'Full e-commerce backend for supplements. FastAPI + PostgreSQL + Redis. Images on Cloudflare R2. Docker Compose deployment.',
     infra:[{k:'Backend',v:'FastAPI'},{k:'DB',v:'PostgreSQL'},{k:'Cache',v:'Redis'},{k:'Images',v:'Cloudflare R2'},{k:'Deploy',v:'Docker Compose'},{k:'Path',v:'~/projects/supplement-ecommerce/'}],
     mods:['Product API','Order Management','Admin Dashboard','Image Upload (R2)','JWT Auth'],conns:['Cloudflare R2','Supplement Storefront']}},
  {id:'supp-web',title:'Supplement Storefront',sub:'Next.js Customer Frontend',icon:'\uD83D\uDED2',c:'gold',s:'dev',x:2220,y:250,cat:['all'],
   stat:'Next.js + Tailwind \u2022 Railway',
   tags:['Next.js','Tailwind','Railway'],
   detail:{desc:'Customer storefront. Next.js 14+ with Tailwind. Deployed on Railway.',
     infra:[{k:'Stack',v:'Next.js + Tailwind'},{k:'Deploy',v:'Railway'},{k:'Path',v:'~/projects/supplement-storefront/'}],
     mods:['Product Catalog','Cart','Checkout'],conns:['Supplement E-commerce API']}},
  {id:'archive',title:'Archived Projects',sub:'6 superseded projects',icon:'\uD83D\uDCE6',c:'gray',s:'parked',x:2220,y:420,cat:['all'],
   stat:'dubai-seminar \u2022 empire-scheduler \u2022 +4',
   tags:['6 projects','archived'],
   detail:{desc:'Superseded: dubai-seminar-landing, empire-scheduler, instantly-automation, ottawa-campaign-dubai, ottawa-campaign, siya-assistant.',
     infra:[{k:'Location',v:'~/projects/_archive/'},{k:'Count',v:'6 projects'}],
     mods:['dubai-seminar-landing','empire-scheduler','instantly-automation','ottawa-campaign-dubai','ottawa-campaign','siya-assistant'],conns:['None']}},
];

// ═══ CONNECTIONS (from → to, with type for color) ═══
const E=[
  // Lead sources → AI
  {f:'atlas2',t:'groq',type:'data',label:'AI + Whisper voice'},
  {f:'atlas2',t:'empire',type:'lead',label:'Lead events & CRM data'},
  {f:'wa-auto',t:'empire',type:'data',label:'Service binding (zero-latency)'},
  {f:'wa-auto',t:'hub',type:'data',label:'Property API queries'},
  {f:'tracker',t:'empire',type:'data',label:'Visitor scores & events'},
  {f:'tracker',t:'telegram',type:'alert',label:'High-intent visitor alerts'},
  // AI → Hub
  {f:'clawd',t:'empire',type:'data',label:'Agent events'},
  {f:'clawd',t:'hub',type:'data',label:'Hub agent operations'},
  {f:'clawd',t:'mcc',type:'content',label:'Content from agents'},
  {f:'launch',t:'empire',type:'alert',label:'New launch alerts'},
  {f:'launch',t:'telegram',type:'alert',label:'Launch detection alerts'},
  {f:'launch',t:'mcc',type:'content',label:'Market intel feed'},
  {f:'ottawa',t:'empire',type:'data',label:'Content events'},
  {f:'ottawa',t:'mcc',type:'content',label:'Cross-border content'},
  // Hub → Storage
  {f:'empire',t:'hub',type:'data',label:'Routed events & data'},
  {f:'hub',t:'pg',type:'data',label:'Property data (ORM)'},
  {f:'hub',t:'lightsail',type:'data',label:'Hosted on'},
  {f:'hub',t:'telegram',type:'alert',label:'Platform alerts'},
  // Storage → Outputs
  {f:'empire',t:'mcc',type:'data',label:'Campaign events'},
  {f:'hub',t:'mcc',type:'content',label:'Property data for content'},
  {f:'videos',t:'mcc',type:'content',label:'Video assets'},
  // Side
  {f:'supp-web',t:'supp-api',type:'data',label:'Storefront API calls'},
];

// ═══ ZONES ═══
const Z=[
  {x:40,y:60,w:W+60,h:640,color:'var(--red-z)',border:'var(--red)',label:'LEAD SOURCES',lx:50,ly:720},
  {x:440,y:60,w:W+60,h:640,color:'var(--orange-z)',border:'var(--orange)',label:'AI PROCESSING',lx:450,ly:720},
  {x:880,y:260,w:W+60,h:160,color:'rgba(34,211,238,0.05)',border:'var(--cyan)',label:'COMMAND HUB',lx:890,ly:440},
  {x:1320,y:60,w:W+60,h:700,color:'var(--green-z)',border:'var(--green)',label:'DATA & STORAGE',lx:1330,ly:780},
  {x:1760,y:60,w:W+60,h:810,color:'var(--purple-z)',border:'var(--purple)',label:'OUTPUTS',lx:1770,ly:890},
  {x:2200,y:60,w:W+60,h:500,color:'var(--gold-z)',border:'var(--gold)',label:'SIDE / ARCHIVE',lx:2210,ly:580},
];

// Column flow arrows
const COL_LABELS=[
  {x:370,y:320,text:'LEADS \u2192'},
  {x:770,y:330,text:'EVENTS \u2192'},
  {x:1210,y:330,text:'ROUTES \u2192'},
  {x:1660,y:330,text:'PUBLISH \u2192'},
];

// ═══ FLOW PATH DEFINITIONS ═══
const FLOWS={
  '1':['atlas2','empire','hub'],
  '2':['tracker','empire','telegram'],
  '3':['launch','empire','mcc'],
  '4':['mcc','empire'],
  '5':['ottawa','mcc','empire'],
  '6':['atlas2','empire','hub','pg'],
};

// ═══ STATE ═══
let pan={x:0,y:0},zoom=1,dragging=false,ds={x:0,y:0},ps={x:0,y:0};
let selNode=null,view='all';
const vp=document.getElementById('vp'),world=document.getElementById('world');

// ═══ RENDER ═══
function render(){
  world.innerHTML='';

  // Grid
  const grid=document.createElement('div');
  grid.style.cssText='position:absolute;top:0;left:0;width:2800px;height:1100px;background-image:radial-gradient(circle at 1px 1px,rgba(255,255,255,0.025) 1px,transparent 0);background-size:40px 40px;z-index:0';
  world.appendChild(grid);

  // Zones
  Z.forEach(z=>{
    const d=document.createElement('div');
    d.className='zone';
    d.style.cssText=`left:${z.x}px;top:${z.y}px;width:${z.w}px;height:${z.h}px;background:${z.color};border:1px solid ${z.border};opacity:0.5`;
    world.appendChild(d);
    const l=document.createElement('div');
    l.className='zone-label';
    l.textContent=z.label;
    l.style.cssText=`left:${z.lx}px;top:${z.ly}px;color:${z.border}`;
    world.appendChild(l);
  });

  // Column flow arrows
  COL_LABELS.forEach(c=>{
    const d=document.createElement('div');
    d.className='col-label';
    d.innerHTML=`<div class="col-arrow">${c.text}</div>`;
    d.style.cssText=`left:${c.x}px;top:${c.y}px`;
    world.appendChild(d);
  });

  // SVG wires
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.classList.add('wires');
  svg.setAttribute('width','2800');svg.setAttribute('height','1100');
  svg.style.cssText='position:absolute;top:0;left:0;z-index:3';

  // Arrow markers
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  ['lead','data','content','alert'].forEach(type=>{
    const col={lead:'#f55a5a',data:'#4a9eff',content:'#b07af5',alert:'#d4a82d'}[type];
    const mk=document.createElementNS('http://www.w3.org/2000/svg','marker');
    mk.setAttribute('id',`arr-${type}`);mk.setAttribute('viewBox','0 0 10 7');
    mk.setAttribute('refX','10');mk.setAttribute('refY','3.5');
    mk.setAttribute('markerWidth','10');mk.setAttribute('markerHeight','8');
    mk.setAttribute('orient','auto');
    const p=document.createElementNS('http://www.w3.org/2000/svg','polygon');
    p.setAttribute('points','0 0, 10 3.5, 0 7');p.setAttribute('fill',col);
    mk.appendChild(p);defs.appendChild(mk);

    // Glow filter
    const fl=document.createElementNS('http://www.w3.org/2000/svg','filter');
    fl.setAttribute('id',`glow-${type}`);fl.innerHTML=`<feGaussianBlur stdDeviation="4" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>`;
    defs.appendChild(fl);
  });
  svg.appendChild(defs);

  E.forEach((e,i)=>{
    const fn=N.find(n=>n.id===e.f),tn=N.find(n=>n.id===e.t);
    if(!fn||!tn)return;
    const fv=fn.cat.includes(view),tv=tn.cat.includes(view);

    const x1=fn.x+W, y1=fn.y+H/2;
    const x2=tn.x, y2=tn.y+H/2;

    // Build clean curved path (horizontal routing)
    const mx=(x1+x2)/2;
    const d=`M${x1},${y1} C${mx},${y1} ${mx},${y2} ${x2},${y2}`;

    const col={lead:'var(--red)',data:'var(--blue)',content:'var(--purple)',alert:'var(--gold)'}[e.type]||'var(--gray)';
    const rawCol={lead:'#f55a5a',data:'#4a9eff',content:'#b07af5',alert:'#d4a82d'}[e.type]||'#6b7a90';

    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',d);
    path.setAttribute('stroke',col);
    path.setAttribute('class','wire');
    path.setAttribute('marker-end',`url(#arr-${e.type})`);
    path.dataset.idx=i;
    path.dataset.from=e.f;path.dataset.to=e.t;
    if(!fv&&!tv)path.classList.add('dim');

    // Hover for label
    path.style.pointerEvents='stroke';path.style.cursor='pointer';
    path.addEventListener('mouseenter',ev=>{
      const wt=document.getElementById('wtip');
      wt.textContent=e.label;
      wt.style.left=ev.clientX+12+'px';wt.style.top=ev.clientY-20+'px';
      wt.classList.add('show');
      path.style.opacity='0.85';path.style.strokeWidth='4';
    });
    path.addEventListener('mouseleave',()=>{
      document.getElementById('wtip').classList.remove('show');
      if(!path.classList.contains('hl')){path.style.opacity='';path.style.strokeWidth='';}
    });
    path.addEventListener('mousemove',ev=>{
      const wt=document.getElementById('wtip');
      wt.style.left=ev.clientX+12+'px';wt.style.top=ev.clientY-20+'px';
    });
    svg.appendChild(path);

    // Persistent wire label
    const lbl=document.createElementNS('http://www.w3.org/2000/svg','text');
    lbl.textContent=e.label;
    lbl.setAttribute('fill',rawCol);
    lbl.setAttribute('opacity','0.55');
    lbl.setAttribute('font-size','9');
    lbl.setAttribute('font-weight','600');
    lbl.setAttribute('font-family','-apple-system,BlinkMacSystemFont,sans-serif');
    // Position label at midpoint of the curve
    const lx=(x1+x2)/2, ly=(y1+y2)/2-8;
    lbl.setAttribute('x',lx);lbl.setAttribute('y',ly);
    lbl.setAttribute('text-anchor','middle');
    lbl.classList.add('wire-label');
    if(!fv&&!tv)lbl.style.display='none';
    svg.appendChild(lbl);

    // Animated dot
    const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
    dot.setAttribute('r','3.5');dot.setAttribute('fill',rawCol);dot.setAttribute('opacity','0.6');
    const am=document.createElementNS('http://www.w3.org/2000/svg','animateMotion');
    am.setAttribute('dur',`${2.5+Math.random()*3}s`);am.setAttribute('repeatCount','indefinite');am.setAttribute('path',d);
    if(!fv&&!tv)dot.style.display='none';
    dot.appendChild(am);svg.appendChild(dot);
  });
  world.appendChild(svg);

  // Cards
  N.forEach(n=>{
    const vis=n.cat.includes(view);
    const d=document.createElement('div');
    d.className=`card c-${n.c}`;
    d.id=`c-${n.id}`;
    d.style.cssText=`left:${n.x}px;top:${n.y}px;width:${W}px;height:${H}px;opacity:${vis?1:0.12};pointer-events:${vis?'auto':'none'}`;
    if(selNode===n.id)d.classList.add('hl');

    const sc=n.s==='live'?'live':n.s==='dev'?'dev':'parked';
    d.innerHTML=`<div class="card-inner"><div class="card-top"><div class="card-icon">${n.icon}</div><div style="flex:1;min-width:0"><div class="card-name">${n.title}</div><div class="card-sub">${n.sub}</div></div><div class="card-status ${sc}"></div></div><div class="card-stat"><span>${n.stat}</span></div></div>`;

    d.addEventListener('click',e=>{e.stopPropagation();toggleSel(n.id)});
    d.addEventListener('mouseenter',e=>showTip(e,n));
    d.addEventListener('mouseleave',()=>hideTip());
    d.addEventListener('mousemove',e=>{const t=document.getElementById('tip');t.style.left=e.clientX+16+'px';t.style.top=e.clientY+16+'px'});
    d.addEventListener('dblclick',e=>{e.stopPropagation();openDP(n)});

    world.appendChild(d);
  });
}

// ═══ SELECTION (click highlights connections) ═══
function toggleSel(id){
  if(selNode===id){selNode=null;clearHL();}
  else{selNode=id;applyHL(id);}
}
function applyHL(id){
  document.querySelectorAll('.card').forEach(c=>{
    const nid=c.id.replace('c-','');
    const connected=E.some(e=>(e.f===id&&e.t===nid)||(e.t===id&&e.f===nid))||nid===id;
    c.classList.toggle('hl',nid===id);
    c.classList.toggle('dim',!connected);
  });
  document.querySelectorAll('.wire').forEach(w=>{
    const hit=w.dataset.from===id||w.dataset.to===id;
    w.classList.toggle('hl',hit);w.classList.toggle('dim',!hit);
  });
}
function clearHL(){
  document.querySelectorAll('.card').forEach(c=>{c.classList.remove('hl','dim')});
  document.querySelectorAll('.wire').forEach(w=>{w.classList.remove('hl','dim');w.style.opacity='';w.style.strokeWidth=''});
}

// ═══ TOOLTIP ═══
function showTip(ev,n){
  const t=document.getElementById('tip');
  let h=`<strong>${n.icon} ${n.title}</strong>${n.detail.desc.slice(0,180)}${n.detail.desc.length>180?'...':''}`;
  h+=`<div class="tip-tags">${n.tags.map(t=>`<span class="tt">${t}</span>`).join('')}</div>`;
  t.innerHTML=h;
  t.style.left=ev.clientX+16+'px';t.style.top=ev.clientY+16+'px';
  t.classList.add('show');
}
function hideTip(){document.getElementById('tip').classList.remove('show')}

// ═══ DETAIL PANEL ═══
function openDP(n){
  const d=n.detail;
  document.getElementById('dpTitle').textContent=n.title;
  document.getElementById('dpSub').textContent=n.sub;
  let h=`<div class="dp-sec"><h4>Overview</h4><p>${d.desc}</p></div>`;
  if(d.infra?.length){h+=`<div class="dp-sec"><h4>Infrastructure</h4>`;d.infra.forEach(i=>h+=`<div class="dp-row"><span class="dk">${i.k}</span><span class="dv">${i.v}</span></div>`);h+=`</div>`}
  if(d.agents?.length){h+=`<div class="dp-sec"><h4>Agents (${d.agents.length})</h4>`;d.agents.forEach(a=>h+=`<div class="dp-agent"><b>${a.n}</b> \u2014 ${a.d}</div>`);h+=`</div>`}
  if(d.mods?.length){h+=`<div class="dp-sec"><h4>Modules (${d.mods.length})</h4><div style="display:flex;flex-wrap:wrap;gap:3px">`;d.mods.forEach(m=>h+=`<span class="dp-tag">${m}</span>`);h+=`</div></div>`}
  if(d.conns?.length){h+=`<div class="dp-sec"><h4>Connections</h4>`;d.conns.forEach(c=>h+=`<div class="dp-conn">${c}</div>`);h+=`</div>`}
  document.getElementById('dpBody').innerHTML=h;
  document.getElementById('dp').classList.add('open');
}
document.getElementById('dpClose').addEventListener('click',()=>document.getElementById('dp').classList.remove('open'));

// ═══ PAN & ZOOM ═══
function tf(){world.style.transform=`translate(${pan.x}px,${pan.y}px) scale(${zoom})`}
vp.addEventListener('mousedown',e=>{if(e.target.closest('.card'))return;dragging=true;vp.classList.add('dragging');ds={x:e.clientX,y:e.clientY};ps={...pan}});
window.addEventListener('mousemove',e=>{if(!dragging)return;pan.x=ps.x+(e.clientX-ds.x);pan.y=ps.y+(e.clientY-ds.y);tf()});
window.addEventListener('mouseup',()=>{dragging=false;vp.classList.remove('dragging')});
vp.addEventListener('wheel',e=>{e.preventDefault();const d=e.deltaY>0?0.92:1.08;const nz=Math.min(2.5,Math.max(0.3,zoom*d));const r=vp.getBoundingClientRect();const mx=e.clientX-r.left,my=e.clientY-r.top;pan.x=mx-(mx-pan.x)*(nz/zoom);pan.y=my-(my-pan.y)*(nz/zoom);zoom=nz;tf();showZoom()},{passive:false});
function showZoom(){const z=document.getElementById('zi');z.textContent=Math.round(zoom*100)+'%';z.classList.add('show');clearTimeout(z._t);z._t=setTimeout(()=>z.classList.remove('show'),1000)}

// Touch
let td=0,tz=0;
vp.addEventListener('touchstart',e=>{if(e.touches.length===2){td=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);tz=zoom}else if(e.touches.length===1){dragging=true;ds={x:e.touches[0].clientX,y:e.touches[0].clientY};ps={...pan}}},{passive:true});
vp.addEventListener('touchmove',e=>{if(e.touches.length===2){const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);zoom=Math.min(2.5,Math.max(0.3,tz*(d/td)));tf()}else if(dragging&&e.touches.length===1){pan.x=ps.x+(e.touches[0].clientX-ds.x);pan.y=ps.y+(e.touches[0].clientY-ds.y);tf()}},{passive:true});
vp.addEventListener('touchend',()=>{dragging=false});

// Click outside
vp.addEventListener('click',e=>{if(!e.target.closest('.card')){selNode=null;clearHL();document.getElementById('dp').classList.remove('open')}});

// ═══ FIT ═══
function fit(){
  const r=vp.getBoundingClientRect(),p=60;
  // Reserve space for fixed overlay panels (legend bottom-left, flows bottom-right)
  const panelH=280;
  let x1=Infinity,y1=Infinity,x2=-Infinity,y2=-Infinity;
  N.forEach(n=>{if(!n.cat.includes(view))return;x1=Math.min(x1,n.x);y1=Math.min(y1,n.y);x2=Math.max(x2,n.x+W);y2=Math.max(y2,n.y+H)});
  Z.forEach(z=>{x1=Math.min(x1,z.x);y1=Math.min(y1,z.y);x2=Math.max(x2,z.x+z.w);y2=Math.max(y2,z.y+z.h+30)});
  const cw=x2-x1+p*2,ch=y2-y1+p*2;
  const availH=r.height-panelH;
  zoom=Math.min(r.width/cw,availH/ch,1.2);
  pan.x=(r.width-cw*zoom)/2-x1*zoom+p*zoom;
  pan.y=(availH-ch*zoom)/2-y1*zoom+p*zoom;
  tf();
}
document.getElementById('fitBtn').addEventListener('click',fit);

// Fullscreen
document.getElementById('fsBtn').addEventListener('click',()=>{if(!document.fullscreenElement)document.documentElement.requestFullscreen().then(()=>setTimeout(fit,100));else document.exitFullscreen()});

// PDF
document.getElementById('pdfBtn').addEventListener('click',()=>{window.print()});

// Tabs
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));t.classList.add('on');view=t.dataset.v;render();setTimeout(fit,50)}));

// Search
document.getElementById('search').addEventListener('input',e=>{const q=e.target.value.toLowerCase();N.forEach(n=>{const el=document.getElementById(`c-${n.id}`);if(!el)return;const m=!q||n.title.toLowerCase().includes(q)||n.sub.toLowerCase().includes(q)||n.tags.some(t=>t.toLowerCase().includes(q));el.style.opacity=m?'1':'0.08'})});

// Legend toggle
document.getElementById('legHead').addEventListener('click',()=>{const l=document.getElementById('legend');l.classList.toggle('shut');document.getElementById('lArr').innerHTML=l.classList.contains('shut')?'&#9654;':'&#9660;'});
// Flows toggle
document.getElementById('flowsHead').addEventListener('click',()=>{const f=document.getElementById('flows');f.classList.toggle('shut');document.getElementById('fArr').innerHTML=f.classList.contains('shut')?'&#9654;':'&#9660;'});

// Flow hover
document.querySelectorAll('.fi').forEach(fi=>{
  fi.addEventListener('mouseenter',()=>{
    const path=FLOWS[fi.dataset.f]||[];
    document.querySelectorAll('.card').forEach(c=>{const id=c.id.replace('c-','');c.classList.toggle('dim',!path.includes(id))});
    document.querySelectorAll('.wire').forEach(w=>{
      const hit=path.some((id,i)=>i<path.length-1&&((w.dataset.from===id&&w.dataset.to===path[i+1])||(w.dataset.to===id&&w.dataset.from===path[i+1])));
      w.classList.toggle('hl',hit);w.classList.toggle('dim',!hit);
    });
  });
  fi.addEventListener('mouseleave',()=>{if(!selNode)clearHL();else applyHL(selNode)});
});

// Keyboard
document.addEventListener('keydown',e=>{if(e.target.tagName==='INPUT')return;if(e.key==='f')fit();if(e.key==='Escape'){selNode=null;clearHL();document.getElementById('dp').classList.remove('open')}if(e.key==='/')e.preventDefault(),document.getElementById('search').focus()});

// ═══ INIT ═══
render();
setTimeout(fit,80);
window.addEventListener('resize',()=>setTimeout(fit,50));
</script>
</body>
</html>
